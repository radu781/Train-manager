<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train manager documentation</title>
</head>

<body>
    <!-- title -->
    <div>
        <h1 class="title">Train manager</h1>
        <h3 class="subtitle">
            <p>
                <span class="highlight">Abstract</span> C++ CLI application for managing train schedules (as a user)
                that simulates a real life Client-Server architecture. An .xml file is used as a database.
            </p>
            <p>
                <span class="highlight">Keywords</span> Concurrent server &middot; Threads &middot; Command pattern
            </p>
        </h3>
        </h1>
    </div>

    <div class="main">
        <!-- chapters -->
        <div class="left">
            <h3>Table of contents</h3>
            <ol>
                <li><a href="#Introduction" class="category">Introduction</a> </li>
                <li>
                    <a href="#Technologies" class="category">Technologies used</a>
                    <ol>
                        <li class="subcategory"><a href="#tcp">TCP</a></li>
                        <li class="subcategory"><a href="#stl">STL</a></li>
                        <li class="subcategory"><a href="#pugi">Pugi xml</a></li>
                    </ol>
                </li>
                <li><a href="#Apparchitecture class=" class="category">App architecture</a>
                    <ol>
                        <li class="subcategory"><a href="#schemaclient">Client</a></li>
                        <li class="subcategory"><a href="#schemaserver">Server</a></li>
                    </ol>
                </li>
                <li><a href="#Implementation" class="category">Implementation details</a>
                    <ol>
                        <li class="subcategory"><a href="#implclient">Client</a>
                            <ol>
                                <li class="subsubcategory"><a href="#implclientbrief">Brief</a></li>
                                <li class="subsubcategory"><a href="#implclientcomm">Communication</a> </li>
                            </ol>
                        </li>
                        <li class="subcategory"><a href="#implserver">Server</a>
                            <ol>
                                <li class="subsubcategory"><a href="#implserverbrief">Brief</a></li>
                                <li class="subsubcategory"><a href="#implservermain">Main loop</a></li>
                                <li class="subsubcategory"><a href="#implservercomm">Communication</a></li>
                                <li class="subsubcategory"><a href="#implserverdata">Data normalization</a></li>
                                <li class="subsubcategory"><a href="#implserverfile">File loading</a></li>
                                <li class="subsubcategory"><a href="#implserverprotocol">Protocol</a></li>
                                <li class="subsubcategory"><a href="#implserverlog">Logging</a></li>
                            </ol>
                        </li>
                        <li class="subcategory"><a href="#implboth">Both (similarities)</a>
                            <ol>
                                <li class="subsubcategory"><a href="#bothdata">Data transfer</a></li>
                                <li class="subsubcategory"><a href="#bothconnection">Connection loss</a></li>
                                <li class="subsubcategory"><a href="#bothbehaviour">Unexpected/wrong client
                                        behaviour</a>
                                </li>
                            </ol>
                        </li>
                        <li class="subcategory"><a href="#impluses">Use cases</a>
                            <ol>
                                <li class="subsubcategory"><a href="#usespref">Preferred bevahiour</a>
                                </li>
                                <li class="subsubcategory"><a href="#cases2">New client</a></li>
                                <li class="subsubcategory"><a href="#casesbad">Bad client</a></li>
                            </ol>
                        </li>
                    </ol>
                </li>
                <li><a href="#Conclusions" class="category">Conclusions</a> </li>
                <li><a href="#Bibliography" class="category">Bibliography</a> </li>
            </ol>
        </div>

        <div class="right">
            <!-- introduction -->
            <div>
                <h3 id="Introduction">Introduction</h3>
                <p>
                    Train manager is a command line interface application that provides users with information regarding
                    domestic trains' timetables in Romania. The entire logic behind the application is done in the
                    server, the clients only send commands and receive data
                    from the server. The server provides the data used by <a href="https://www.cfrcalatori.ro/"
                        class="externallink"> Cfr Călători</a>, cloning part of their functionality. The database
                    inquired for this project is
                    an <span class="code">.xml</span> file (as this is how Cfr Călători stores their data) so an <a
                        href="#pugi" class="internallink">xml parser</a> was used. Additional information (more in depth
                    code details) about classes, class methods
                    and members can be found in the project's source files as Doxygen comments. <i>(Disclosure: code
                        snippets in this documentation may not be up to date)</i>
                </p>
            </div>

            <!-- technologies -->
            <div>
                <h3 id="Technologies">Technologies used</h3>
                <p>
                    <span class="highlight" id="tcp">TCP</span> Connection oriented interaction between the server and
                    the clients. Due to the error checking, 3 way handshaking and data retransmission, this type of
                    connection is more reliable, but also
                    slower. Since accuracy is arguably more important than low latency, a TCP connection was employed
                    for all communications, rather than a faster, yet less reliable UDP one.
                </p>
                <p>
                    <span class="highlight" id="stl">STL</span> The standard template library provides data structures
                    that are a must have in all C++ projects. In this project, std::pair, std::string, std::vector,
                    std::unordered_map, std::unordered_set
                    were made use of.
                </p>
                <p>
                    <a href="#pugibibl" class="internallink"> <span class="highlight" id="pugi">Pugixml</span></a> is
                    the api used to parse the xml file. It provides functions that can load, traverse and modify data in
                    the file. The internal data is stored as a tree (more exactly, a DOM-like
                    object). Even though memory and speed improvements have been made at the cost of not validating
                    data, it is assumed that the xml file is valid. Despite using such a rich library, only several
                    methods are used in order to achieve the
                    project's goal.
                </p>
            </div>

            <!-- architecture -->
            <div>
                <h3 id="Apparchitecture">App architecture</h3>
                <p id="schemaclient" class="subhighlight">Client</p>
                <p class="arch-img">
                    <img src="resources/client.svg" alt="Client diagram">
                </p>
                <p id="schemaserver" class="subhighlight">Server</p>
                <p class="arch-img">
                    <img src="resources/server.svg" alt="Server diagram">
                </p>
            </div>

            <!-- implementation -->
            <div>
                <h3 id="Implementation">Implementation details</h3>
                <ol>
                    <li id="implclient" class="subhighlight">Client</li>
                    <p>
                        <span id="implclientbrief" class="highlight">Brief </span> The client side of the application is
                        relatively straight forward: once a connection to the server is established, the client is free
                        to receive and send messages until
                        they quit, unexpectedly close the application or lose the connection to the server. The first
                        function that is called in the client is <span class="code">makeConnection()</span>, a function
                        will attempt several times to establish
                        a connection and that throws if unable to connect.
                    </p>
                    <p>
                    <div class="code">
                        <span class="hide"><a href="../Client/src/connection.cpp"
                                class="filelink">Client/src/connection.cpp</a></span>
                        <button id="button0" onclick="change(0)">Show code</button>
                        <div class="codefield" id="code0">
                            <span class="code">
                                void Connection::makeConnection() <br>
                                {<br>
                                <a class="tab"></a>if ((serverFD = socket(AF_INET, SOCK_STREAM, 0)) < 0) <br>
                                    <a class="tab"></a>
                                    <a class="tab"></a>throw ConnectionException("Socket creation error"); <br>
                                    <br>
                                    <a class="tab"></a>serv_addr.sin_family = AF_INET; <br>
                                    <a class="tab"></a>serv_addr.sin_port = htons(PORT); <br> <br>
                                    <a class="tab"></a>if (inet_pton(AF_INET, "127.0.0.1", &serv_addr.sin_addr) <= 0)
                                        <br>
                                        <a class="tab"></a>
                                        <a class="tab"></a>throw ConnectionException("IPv4 address conversion error");
                                        <br> <br>
                                        <a class="tab"></a>const unsigned RETRY_ATTEMPTS = 5, TIME = 1; <br>

                                        <a class="tab"></a>LoadingBar bar(RETRY_ATTEMPTS, TIME); <br>

                                        <a class="tab"></a>for (unsigned i = 0; i < RETRY_ATTEMPTS; i++) <br>
                                            <a class="tab"></a>
                                            <a class="tab"></a>if (connect(serverFD, (struct sockaddr *)&serv_addr,
                                            sizeof(serv_addr)) < 0) <br>
                                                <a class="tab"></a>
                                                <a class="tab"></a>{ <br>
                                                <a class="tab"></a>
                                                <a class="tab"></a>
                                                <a class="tab"></a>char buf[64]; <br>
                                                <a class="tab"></a>
                                                <a class="tab"></a>
                                                <a class="tab"></a>unsigned seconds = TIME + i * 2; <br>
                                                <a class="tab"></a>
                                                <a class="tab"></a>
                                                <a class="tab"></a>sprintf(buf, "%u/%u Connection failed, retrying in
                                                %u seconds" , i
                                                + 1, RETRY_ATTEMPTS, seconds); <br>
                                                <a class="tab"></a>
                                                <a class="tab"></a>
                                                <a class="tab"></a>std::cout &lt;&lt; buf &lt;&lt; std::flush; <br>
                                                <a class="tab"></a>
                                                <a class="tab"></a>
                                                <a class="tab"></a>bar.update(seconds); <br>
                                                <a class="tab"></a>
                                                <a class="tab"></a>} <br>
                                                <a class="tab"></a>
                                                <a class="tab"></a>else <br>
                                                <a class="tab"></a>
                                                <a class="tab"></a>{ <br>
                                                <a class="tab"></a>
                                                <a class="tab"></a>
                                                <a class="tab"></a>connected = true; <br>
                                                <a class="tab"></a>
                                                <a class="tab"></a>
                                                <a class="tab"></a>return; <br>
                                                <a class="tab"></a>
                                                <a class="tab"></a>} <br><br>
                                                <a class="tab"></a>throw ConnectionException("Server connection
                                                error");<br>
                                                }
                            </span>
                        </div>
                    </div>
                    </p>
                    <p>
                        <span id="implclientcomm" class="highlight">Communication </span>After connecting to the server,
                        two threads are created: a reader and a sender that allow for continuous and uninterrupted data
                        transfer. Since the data is plaintext,
                        it can be easily printed. The send thread reads the client input line by line, while the read
                        thread reads data from the server by calling two helper functions: <span class="code">
                            allocateReader()</span> and <span class="code">
                            split()</span> that extract the data, separating it from the byte size and padding (see <a
                            href="#datatransfer" class="internallink"> Data transfer</a>).
                    </p>
                    <li id="implserver" class="subhighlight">Server</li>
                    <p>
                        <span id="implserverbrief" class="highlight">Brief</span> The server side of the application is
                        more complex because it manages connections with multiple clients at a time and executes their
                        commands while also avoiding race conditions.
                        Similar to the client, the first method called is
                        <span class="code"> makeConnection()</span>, a function that throws if unable to connect.
                    </p>

                    <div class="code">
                        <span class="hide"><a href="../Server/src/connection.cpp"
                                class="filelink">Server/src/connection.cpp</a></span>
                        <button id="button1" onclick="change(1)">Show code</button>
                        <div class="codefield" id="code1">

                            <span class="code">
                                void Connection::makeConnection() <br>
                                { <br>
                                <a class="tab"></a>int optVal = 1; <br>
                                <br>
                                <a class="tab"></a>if ((socketFD = socket(AF_INET, SOCK_STREAM, 0)) == 0) <br>
                                <a class="tab"></a><a class="tab"></a>throw ConnectionException("Socket creation
                                error");
                                <br>
                                <a class="tab"></a>if (setsockopt(socketFD, SOL_SOCKET, SO_REUSEADDR, &optVal,
                                sizeof(optVal)))
                                <br>
                                <a class="tab"></a><a class="tab"></a><a class="tab"></a>throw
                                ConnectionException("Could
                                not attach socket to port
                                (setsockopt)");
                                <br>
                                <br>
                                <a class="tab"></a>address.sin_family = AF_INET; <br>
                                <a class="tab"></a>address.sin_addr.s_addr = INADDR_ANY; <br>
                                <a class="tab"></a>address.sin_port = htons(PORT); <br>
                                <br>
                                <a class="tab"></a>if (bind(socketFD, (struct sockaddr *)&address, sizeof(address)) < 0)
                                    <br>
                                    <a class="tab"></a><a class="tab"></a>throw ConnectionException("Could not attach
                                    socket
                                    to port
                                    (bind)");
                                    <br>
                                    <a class="tab"></a>if(listen(socketFD, 3) &lt; 0) <br>
                                    <a class="tab"></a><a class="tab"></a>throw ConnectionException("Could not
                                    listen
                                    from the server!");
                                    <br>
                                    }
                            </span>
                        </div>
                    </div>
                    <p>
                        <span id="implservermain" class="highlight">Main loop</span> After establishing the connection,
                        the server's main loop accepts clients, sends them the message of the day and stores them into
                        an unordered map. This thread is equivalent
                        to the main thread, upon finishing its execution (which may only occur in the case of an
                        uncaught exception) it closes the server (realistically this will never happen). The server will
                        only send data when requested. For each client the <span class="code">runIndividual()</span>
                        method is called that creates a reader thread, while the main thread will delete the client
                        entry in the unordered map upon disconnection (see <a href="#conenctionloss"
                            class="internallink"> Connection loss</a>).
                    </p>
                    <p>
                        <span id="implservercomm" class="highlight">Communication</span> Sending and reading data is the
                        same as on the client side (see <a href="#bothdata" class="internallink"> Data
                            transfer</a>), except that the client input is also parsed. This input is tokenized,
                        validated in order to check if the requested action is supported and if the argument count is
                        correct, normalized and finally executed.
                    </p>
                    <p>
                        <span id="implserverdata" class="highlight">Data normalization</span> All client input and
                        replaced by their non-diacritics equivalent (e.g. ”ă”, ”â” become ”a”). In addition, functions
                        that find station names also accept partial
                        and close matches (by using <a href="https://en.wikipedia.org/wiki/Levenshtein_distance"
                            class="externallink">Levenshtein
                            distance</a>), however exact matches are prioritized. Find functions return multiple match
                        values like a real life search bar. For example, "cluj" will find the train stations "cluj
                        napoca", "cluj napoca est" and "iaai" will
                        find "iasi".
                    </p>
                    <p>
                        <span id="implserverfile" class="highlight">File loading</span> When started, the server will
                        call the <span class="code">getFile()</span> method that will load the locally saved xml file
                        (if it exists). Upon failure (file could
                        not be found), it will attempt to download the file (using the utilitary <span
                            class="code">wget</span>) from a <a
                            href="https://data.gov.ro/dataset/c4f71dbb-de39-49b2-b697-5b60a5f299a2/resource/5af0366b-f9cb-4d6e-991b-e91789fc7d2c/download/sntfc-cfr-cltori-s.a.-1232-trenuri_2021.xml"
                            class="externallink">public source</a> (not shown in the code example). In addition to
                        loading the file, this function will also store the station names and train numbers in member
                        variables in order for them to be validated faster
                        (not shown here). This operation is thread safe and will always succeed to load the file (except
                        if the source is down, which is unlikely).
                    </p>
                    <div class="code">
                        <span class="hide"><a href="../Server/src/connection.cpp"
                                class="filelink">Server/src/connection.cpp</a></span>
                        <button id="button2" onclick="change(2)">Show code</button>
                        <div class="codefield" id="code2">
                            <span class="code">
                                void Command::getFile() <br>
                                { <br>
                                <a class="tab"></a>const std::string localPath = "resources/cfr_2021.xml"; <br>
                                <a class="tab"></a>const std::string web = "..."; <br>
                                <a class="tab"></a>const std::string args = "--tries=3 -O " + localPath; <br>

                                <a class="tab"></a>if (!std::filesystem::exists(localPath)) <br>
                                <a class="tab"></a>{ <br>
                                <a class="tab"></a>
                                <a class="tab"></a>std::lock_guard<std::mutex> lock(m); <br>
                                    <br>
                                    <a class="tab"></a>
                                    <a class="tab"></a>LOG_DEBUG("Xml does not exist locally, attempting to
                                    download");<br>
                                    <a class="tab"></a>
                                    <a class="tab"></a>if (system(("wget " + web + args).c_str()) < 0) <br>
                                        <a class="tab"></a>
                                        <a class="tab"></a>
                                        <a class="tab"></a>LOG_DEBUG("Xml failed to download"); <br>
                                        <a class="tab"></a>
                                        <a class="tab"></a>else<br>
                                        <a class="tab"></a>
                                        <a class="tab"></a>
                                        <a class="tab"></a>LOG_DEBUG("Xml downloaded"); <br>

                                        <a class="tab"></a>} <br>
                                        <a class="tab"></a>if (!doc.empty()) <br>
                                        <a class="tab"></a>{ <br>
                                        <a class="tab"></a>
                                        <a class="tab"></a>LOG_DEBUG("Loaded xml"); <br>
                                        <a class="tab"></a>
                                        <a class="tab"></a>doc.load_file(localPath.c_str()); <br>
                                        <a class="tab"></a>} <br>
                                        }
                            </span>
                        </div>
                    </div>
                    <p>
                        <span id="implserverprotocol" class="highlight">Protocol</span> Commands may have a fixed or a
                        flexible number of arguments (or optional). As of yet, the supported commands are:
                    <table>
                        <th class="slim">Command name</th>
                        <th class="slim">Mandatory args<sup><a href="#args" class="internallink">1</a></sup></th>
                        <th class="slim">Optional args<sup><a href="#args" class="internallink">1</a></sup></th>
                        <th class="wide">Effect</th>

                        <tr>
                            <td><span class="code">today</span></td>
                            <td class="digit">2<br>(city names)</td>
                            <td class="digit">any<sup><b><a href="#protocolany" class="internallink">2</a></b></sup>
                            </td>
                            <td>Prints the arrival and destination times of trains in given stations<br>It first prints
                                a verbose result (all intermediary stations and time stamps) and then a brief one (only
                                start and destination stations with their respective time stamps) that is omitted if
                                there are no intermediary stations (see <a href="#impluses" class="internallink">Use
                                    cases</a>)
                            </td>
                        </tr>
                        <tr>
                            <td><span class="code">departures</span></td>
                            <td class="digit">2<br>(city name, delta<sup><b><a href="#protocoldelta"
                                            class="internallink">3</a></b></sup>)</td>
                            <td class="digit">any<sup><b><a href="#protocolany" class="internallink">2</a></b></sup>
                            </td>
                            <td>Prints the trains that depart from the given station in the upcoming delta<sup><b><a
                                            href="#protocoldelta" class="internallink">3</a></b></sup> time
                                <br>Similarly to <span class="code">today</span>, two results are printed: a
                                verbose and a brief one
                            </td>
                        </tr>
                        <tr>
                            <td><span class="code">arrivals</span></td>
                            <td class="digit">2<br>(city name, delta<sup><b><a href="#protocoldelta"
                                            class="internallink">3</a></b></sup>)</td>
                            <td class="digit">any<sup><b><a href="#protocolany" class="internallink">2</a></b></sup>
                            </td>
                            <td>Prints the trains that arrive at the given station in the upcoming delta<sup><b><a
                                            href="#protocoldelta" class="internallink">3</a></b></sup>
                                time<br>Similarly to <span class="code">today</span>, two results are printed: a
                                verbose and a brief one
                            </td>
                        </tr>
                        <tr>
                            <td><span class="code">late</span></td>
                            <td class="digit">2<br>(city name, delta<sup><b><a href="#protocoldelta"
                                            class="internallink">3</a></b></sup>)</td>
                            <td class="digit">any<sup><b><a href="#protocolany" class="internallink">2</a></b></sup>
                            </td>
                            <td>Proposes a delay for a given train, future calls to <span class="code">today</span>,
                                <span class="code">departures</span> and <span class="code">arrivals</span> will be
                                altered
                            </td>
                        </tr>
                        <tr>
                            <td><span class="code">help</span></td>
                            <td class="digit">0</td>
                            <td class="digit">1<br>(specific command)</td>
                            <td>Prints general help information or specific to a command</td>
                        </tr>
                        <tr>
                            <td><span class="code">quit</span></td>
                            <td class="digit">0</td>
                            <td class="digit">0</td>
                            <td>Shuts down the client connection, this command doesn't reach the server</td>
                        </tr>

                    </table>
                    <p>
                        <sup id="args"><b>1</b></sup>An argument is a word separated by at least one space character, or
                        one of the following: <span class="code">,;'?</span>. The period (<span class="code">.</span>)
                        is not a valid delimiter since some stations use this in their name.
                        <br>
                        <sup id="protocolany"><b>2</b></sup>City names can be longer than a single word, however partial
                        matches will return more results.<br>
                        <sup id="protocoldelta"><b>3</b></sup>Delta can be either a number or a literal. If it's only
                        formed by digits, those are interpreted as seconds. Otherwise, the literal is evaluated: <span
                            class="code">s</span> represents seconds,
                        <span class="code">m</span> represents minutes and <span class="code">h</span> represents hours.
                        The digits before these characters are added up by category. For example: "1000" and "1000s"
                        translate to a delta of 1000 seconds,
                        "10m" is 10 minutes, "15m45s" is 15 minutes and 45 seconds, "10m2s25m" is 35 minutes and 2
                        seconds.
                    </p>
                    <p>
                        All commands (apart from <span class="code">help</span> and <span class="code">quit</span>) have
                        to search for the user inputted station or train name. These names are <span
                            id="cache">cached</span> when the server
                        starts (and <span class="code">getFile()</span> is called, see <a href="#implserverfile"
                            class="internallink">File loading</a>). In case of total mismatch (no exact, partial or
                        close matches are found) the functions are considerably faster, having to only iterate over
                        &approx;
                        1500 unique station names or &approx; 1200 unique train names, depending on the command issued,
                        instead of the whole xml (&approx; 30.000 stations and &approx; 1200 trains). Of course, this
                        adds unnecessary checks even though the station names might be correct, but this is only equal
                        to <sup>1</sup>/<sub>60</sub> of the time to actually find the stations (yes, this was timed).
                    </p>
                    <p>
                        Commands that are received by the server (all but <span class="code">quit</span>) are separate
                        classes that implement the <a href="../Server/include/commands/command.hpp"
                            class="filelink">Command</a> abstract class. These commands are not stand-alone, and require
                        the data in the base class (pointers to data from <a
                            href="../Server/include/communication/commandparser.hpp" class="filelink">CommandParser</a>,
                        passed at initialization and some member functions). A better Command Pattern demonstration
                        would have an interface as its base class, but since the commands are centered around the same
                        data, it seemed better practice to share the functionality whenever needed.
                    </p>
                    </p>
                    <p>
                        <span id="implserverlog" class="highlight">Logging</span> Client to server and server to client
                        messages are logged, as well as debug related information such as: clients being accepted,
                        clients losing connection, inner server data changes: files being downloaded, memory usage, etc.
                        The logger crates a text file on each run with the current time as its name and previous log
                        files are archived. Logging is thread safe and (purposefully) slow in order to log everything in
                        case of crashes, however it can be disabled by removing compile time defines (<span
                            class="code">ENABLE_COMM_LOGGING</span>, <span class="code">ENABLE_DEBG_LOGGING</span> in
                        the server's root
                        <a href="../Server/Makefile" class="filelink">Makefile</a>).
                    </p>
                    <li id="implboth" class="subhighlight">Both (similarities)</li>
                    <p>
                        <span id="bothdata" class="highlight" id="datatransfer">Data transfer</span> In order to
                        efficiently send and read data, messages coming from both the client and server use the format
                        <span class="code">[byte_size][padding][message]</span>, such that upon sending, the reader is
                        able to allocate a buffer with the exact size of data to be received. As far as data types are
                        concerned, <span class="code">byte_size</span> is <span class="code">size_t</span>, <span
                            class="code">padding</span> and <span class="code">message</span> are C-style character
                        arrays (<span class="code">char *</span>). An initial buffer is first used to read at least the
                        first part of the message (<span class="code">[byte_size][padding]</span>), after which, if
                        needed (message length is longer than the size of the initial buffer, most common case), the
                        read function will be called again. Example
                        of sender and reader allocation: <br>
                    </p>

                    <div class="code">
                        <span class="hide"><a href="../Server/src/iomanager.cpp"
                                class="filelink">Server/src/iomanager.cpp</a></span>
                        <button id="button3" onclick="change(3)">Show code</button>
                        <div class="codefield" id="code3">
                            <span class="code">
                                std::pair&lt;char *, size_t> IOManager::allocateSender(const std::string &str)<br>
                                { <br>
                                <a class="tab"></a>const size_t bytes = str.size() * sizeof(str[0]) + 1; <br>
                                <a class="tab"></a>const size_t dataSize = bytes + strlen(PADDING) + 12; <br>
                                <a class="tab"></a>char *allocated = new char[dataSize]{}; <br>
                                <a class="tab"></a>snprintf(allocated, dataSize, "\%lu\%s\%s", bytes,
                                PADDING,str.c_str());
                                <br>
                                <a class="tab"></a>return {allocated, dataSize};<br>
                                }
                            </span>
                        </div>
                    </div>
                    <p></p>
                    <div class="code">
                        <span class="hide"><a href="../Server/src/iomanager.cpp"
                                class="filelink">Server/src/iomanager.cpp</a></span>
                        <button id="button4" onclick="change(4)">Show code</button>
                        <div class="codefield" id='code4'>
                            <span class="code">
                                std::pair&lt;char *, size_t> IOManager::allocateReader(const char *buff)<br>
                                { <br>
                                <a class="tab"></a>auto [msg, size] = split(buff); <br>
                                <a class="tab"></a>char *wholeMessage = new char[size]{}; <br>
                                <a class="tab"></a>strcpy(wholeMessage, msg); <br>
                                <br>
                                <a class="tab"></a>return {wholeMessage, size};<br>
                                }<br>
                                std::pair&lt;const char *, size_t> IOManager::split(const char *str) <br>
                                { <br>
                                <a class="tab"></a>const char *paddingStart = strstr(str, PADDING);<br>
                                <a class="tab"></a>if (paddingStart == nullptr)<br>
                                <a class="tab"></a>
                                <a class="tab"></a>throw std::runtime_error("Padding not found");<br>
                                <br>
                                <a class="tab"></a>char length[BUFF_SIZE + 1]{};<br>
                                <a class="tab"></a>for (int i = 0; i &lt; paddingStart - str; i++)<br>
                                <a class="tab"></a>
                                <a class="tab"></a>length[i] = str[i];<br>
                                <br>
                                <a class="tab"></a>return {paddingStart + strlen(PADDING),
                                atoi(length)};<br>
                                }
                            </span>
                        </div>
                    </div>
                    <p>
                        The purpose of the padding is only to differentiate the message size from the actual message and
                        is composed of distinctive characters. All read/send operations are wrapped by functions in the
                        IOManager class.
                    </p>
                    <p>
                        <span class="highlight" id="bothconnection">Connection loss</span> Read and send operations
                        check if the buffer received or sent match their size. In the eventuality that the sizes are
                        different, an exception is thrown, however,
                        if the value returned by the system <span class="code">read()</span> or <span
                            class="code">write()</span> corresponds to an error, the connection is closed, assuming that
                        the client or server has abruptly disconnected. In case the client loses connection, the server
                        will be unaffected, and able to accept other (including the same) clients. If the server shuts
                        down, all clients' connections will be closed as no more data can be received. The <span
                            class="code">read()</span> and <span class="code">write()</span> IOManager methods toggle
                        the <span class="code">isConnected</span> client member variable if the connection is lost, thus
                        the <span class="code">runIndividual()</span> method can efficiently remove the client from the
                        clients map.
                    </p>

                    <div class="code">
                        <span class="hide"><a href="../Server/src/connection.cpp"
                                class="filelink">Server/src/connection.cpp</a></span>
                        <button id="button5" onclick="change(5)">Show code</button>
                        <div class="codefield" id="code5">
                            <span class="code">
                                void Connection::runIndividual(Client *client) <br>
                                { <br>
                                <a class="tab"></a>std::thread reader(readIndividual, client); <br>
                                <a class="tab"></a>reader.join(); <br>
                                <br>
                                <a class="tab"></a>if (!client->isConnected) <br>
                                <a class="tab"></a>{ <br>
                                <a class="tab"></a>
                                <a class="tab"></a>clients.erase(client->sock); <br>
                                <a class="tab"></a>
                                <a class="tab"></a>LOG_DEBUG("Client erased"); <br>
                                <a class="tab"></a><a class="tab"></a>if (clients.size() &lt; prethreadCount / 5)<br>
                                <a class="tab"></a><a class="tab"></a><a class="tab"></a>makeThreads();<br>
                                <a class="tab"></a>} <br>
                                }
                            </span>
                        </div>
                    </div>
                    <p>
                        <span id="bothbehaviour" class="highlight">Unexpected/wrong client behaviour</span> Upon using
                        commands that generate an empty output, nonexistent commands or commands with a wrong number of
                        arguments, the client will be advised
                        on their proper usage.
                    </p>
                    <li id="impluses" class="subhighlight">Use cases</li>
                    <p>
                        The server is started. Multiple client connections are made. The following scenarios can be
                        assumed (non-essential data is omitted by "[...]"):
                    <ul>
                        <li>
                            <span id="usespref" class="highlight">Preferred behaviour</span> the client tries to (and
                            knows how to) get information about two trains:
                        </li>
                        <div class="code">
                            <span class="hide">Terminal output</span>
                            <button id="button6" onclick="change(6)">Show output</button>
                            <div class="codefield" id="code6">
                                <span class="code">
                                    $ bin/main <br>
                                    ---Welcome to Train Manager--- <br>
                                    Today is 25/12/2021(Saturday) <br>
                                    today iasi bucuresti <br>
                                    Found 5 trains: <br>
                                    1. IR1660 <br>
                                    (06:20 -> 06:24, 04 min) Iaşi -> Nicolina <br>
                                    (06:25 -> 06:31, 06 min) Nicolina -> Ciurea Hm. <br>
                                    (06:31 -> 06:44, 13 min) Ciurea Hm. -> Bârnova Hm. <br>
                                    [...] <br>
                                    (12:40 -> 12:43, 03 min) P. mac. R1 Buciumeni -> Chitila <br>
                                    (12:43 -> 12:54, 11 min) Chitila -> Bucureşti Nord Gr.A <br>
                                    <br>
                                    2. IR1662 <br>
                                    (14:15 -> 14:19, 04 min) Iaşi -> Nicolina <br>
                                    (14:21 -> 14:27, 06 min) Nicolina -> Ciurea Hm. <br>
                                    (14:27 -> 14:40, 13 min) Ciurea Hm. -> Bârnova Hm. <br>
                                    [...] <br>
                                    (20:35 -> 20:37, 02 min) P. mac. R1 Buciumeni -> Chitila <br>
                                    (20:37 -> 20:47, 10 min) Chitila -> Bucureşti Nord Gr.A <br>
                                    <br>
                                    3. IR1664 <br>
                                    (15:58 -> 16:02, 04 min) Iaşi -> Nicolina <br>
                                    [...] <br>
                                    (22:07 -> 22:17, 10 min) Chitila -> Bucureşti Nord Gr.A <br>
                                    <br>
                                    4. IR1854-1 <br>
                                    (23:13 -> 23:27, 14 min) Iaşi -> Leţcani <br>
                                    [...] <br>
                                    (06:08 -> 06:20, 12 min) Chitila -> Bucureşti Nord Gr.A <br>
                                    <br>
                                    5. IR-N1668 <br>
                                    (23:15 -> 23:19, 04 min) Iaşi -> Nicolina <br>
                                    [...] <br>
                                    (05:45 -> 05:55, 10 min) Chitila -> Bucureşti Nord Gr.A <br>
                                    <br>
                                    At a glance (2/5 trains available) <br>
                                    Number Depart Arrival Time <br>
                                    [x] 1. IR1660 (06:20 -> 12:54, 06:34) Iaşi -> Bucureşti Nord Gr.A <br>
                                    [x] 2. IR1662 (14:15 -> 20:47, 06:32) Iaşi -> Bucureşti Nord Gr.A <br>
                                    [x] 3. IR1664 (15:58 -> 22:17, 06:19) Iaşi -> Bucureşti Nord Gr.A <br>
                                    ---------- <br>
                                    [o] 4. IR1854-1 (23:13 -> 06:20, 07:07 +1day) Iaşi -> Bucureşti Nord Gr.A <br>
                                    [o] 5. IR-N1668 (23:15 -> 05:55, 06:40 +1day) Iaşi -> Bucureşti Nord Gr.A <br>
                                    <br>
                                    departures cluj 10m <br>
                                    Number Depart Arrival Time <br>
                                    [o] 1. R4705 (13:20 -> 13:25, 00:05) Cluj Napoca -> Baciu Triaj Hm. <br>
                                    [o] 2. R4703 (13:20 -> 13:26, 00:06) Cluj Napoca Est -> Apahida <br>
                                </span>
                            </div>
                        </div>
                        <li><span id="cases2" class="highlight">New client</span> The unexperienced client has no idea
                            how to use the system:
                        </li>
                        <div class="code">
                            <span class="hide">Terminal output</span>
                            <button id="button7" onclick="change(7)">Show output</button>
                            <div class="codefield" id="code7">
                                <span class="code">
                                    ---Welcome to Train Manager--- <br>
                                    Today is 25/12/2021(Saturday) <br>
                                    today <br>
                                    Command today has 2 mandatory arguments, 0 provided <br>
                                    help <br>
                                    Supported commands: <br>
                                    today [start] [dest] (get today's trains schedules from [start] to [dest]) <br>
                                    departures [start] [delta] (get the departures from [start] [...]) <br>
                                    arrivals [dest] [delta] (get the arrivals to [dest] [...] <br>
                                    quit (close the connection) <br>
                                    help [command] (get more detailed help about a command) <br>
                                    today brasov <br>
                                    Command today has 2 mandatory arguments, 1 provided <br>
                                    depart <br>
                                    Command depart not found <br>
                                </span>
                            </div>
                        </div>
                        <li>
                            <span id="casesbad" class="highlight">Bad client</span> The evil client tries to find
                            exploits: by entering a command longer than the available buffer (of constant size), the
                            command will be invalidated and the connection will be closed. Entering new lines or random
                            unicode characters will do nothing. Entering EOF will cause the client to no longer be able
                            to send commands. Sending a command that outputs Thus, the server will not crash due to user
                            input.
                        </li>
                    </ul>
                    </p>
                </ol>
            </div>

            <!-- conclusions -->
            <div>
                <h3 id="Conclusions">Conclusions</h3>
                <p>
                    This application can be used to accurately tell the domestic timetable of trains in Romania, cloning
                    part of Cfr Călători's functionality. Improvement ideas (proposed, implemented and not implemented)
                    along the project's development that do not necessarily have to do with the main project's idea:
                <ul>
                    <li>
                        Code related/server only
                        <ul>
                            <li>fix a bug where read/send operations have to check for empty strings (not fatal, just
                                annoying to have to always consider this)</li>
                            <li>delays will be reset the upcoming day</li>
                            <li>broadcast feature for the server, maybe also server only commands</li>
                            <li>automatically download the latest data (for 2022, 2023 or whenever it changes)</li>
                            <li><span class="strike">fewer hardcoded variables</span> all data is as dynamic as it can
                                be, based on the xml file</li>
                            <li><span class="strike">efficiency: cache the results for sub-linear searches</span> <a
                                    href="#cache" class="internallink">only for failure</a> </li>
                        </ul>
                    </li>
                    <li>
                        User convenience/client only
                        <ul>
                            <li>make a minimal UI</li>
                            <li>make the client application cross platform</li>
                            <li><span class="strike">more commands: search by train number or type</span> <span
                                    class="code">late</span> command does this</li>
                            <li><span class="strike">make searches more permissive: substrings, close matches</span> <a
                                    href="#implserverdata" class="internallink"> done</a></li>
                            <li><span class="strike">add reconnect system in case the server disconnects</span> only
                                implemented when the user starts their application</li>
                        </ul>
                    </li>
                </ul>
                </p>
            </div>

            <!-- bibliography -->
            <div>
                <h3 id="Bibliography">Bibliography</h3>
                <p>
                    This project could not be finalized without the help of:
                <ul>
                    <li>Tutorials from Geeks for Geeks</li>
                    <ul>
                        <li><a href="https://www.geeksforgeeks.org/socket-programming-cc/" class="externallink">
                                https://www.geeksforgeeks.org/socket-programming-cc/</a></li>
                        <li><a href="https://www.geeksforgeeks.org/tcp-server-client-implementation-in-c/"
                                class="externallink">
                                https://www.geeksforgeeks.org/tcp-server-client-implementation-in-c/</a></li>
                    </ul>
                    <li><span id="pugibibl">Arseny Kapoulkine's xml parser</span></li>
                    <ul>
                        <li><a href="https://github.com/zeux/pugixml" class="externallink">
                                https://github.com/zeux/pugixml
                            </a>
                        </li>
                        <li><a href="https://pugixml.org/" class="externallink"> https://pugixml.org/ </a></li>
                    </ul>
                </ul>
                </p>
            </div>
        </div>
    </div>
</body>

<style>
    .main {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
    }

    .left {
        position: sticky;
        position: -webkit-sticky;
        top: 0;
        left: 0;
        align-self: flex-start;
        padding-right: 5px;
        padding-bottom: 20%;
        margin-right: 5px;
        border-right: 2px solid gray;
        background-color: #80808030;
    }

    @media (max-width: 1000px) {
        .main {
            flex-direction: column;
        }

        .left {
            border: none;
            position: relative;
        }
    }

    html {
        margin-bottom: 10%;
        padding: 0;
        scroll-behavior: smooth;
        text-align: justify;
    }

    body {
        margin: 0;
        margin-right: 5px;
        padding: 0;
    }

    .strike {
        text-decoration: line-through;
    }

    .title,
    .subtitle {
        text-align: center;
        padding: 0% 20%;
    }

    h3 {
        font-family: Arial, Helvetica, sans-serif;
    }

    h1 p,
    h3 p {
        padding: 0;
        margin: 0;
        font-weight: 300;
    }

    .highlight {
        font-weight: 700;
        font-style: italic;
    }

    .subhighlight {
        font-family: 'Segoe UI', Tahoma, 'Geneva', Verdana, sans-serif;
        font-size: large;
    }

    a {
        text-decoration: none;
        color: hsl(266, 79%, 39%);
    }

    .internallink {
        color: rgb(192, 0, 0);
        transition: 250ms;
    }

    .externallink {
        color: rgb(0, 192, 192);
        transition: 250ms;
    }

    .filelink {
        color: rgb(0, 189, 0);
        transition: 250ms;
    }

    a:hover {
        background-color: rgb(224, 224, 224);
        border-radius: 5px;
        border-width: 10px;
        transition: all 250ms ease-in;
    }

    .arch-img {
        text-align: left;
    }

    img {
        width: 40%;
        padding: 0 30%;
        text-align: center;
    }

    li .category {
        font-size: larger;
    }

    li .subcategory {
        font-size: large;
        list-style-type: lower-latin;
    }

    li .subsubcategory {
        font-size: medium;
        list-style-type: lower-roman;
    }

    .code {
        background-color: rgb(224, 224, 224);
        position: relative;
        width: fit-content;
        font-family: 'Courier New', Courier, monospace;
        border-radius: 3px;
    }

    .code .codefield {
        visibility: hidden;
        height: 0;
        display: none;
    }

    p~.code {

        background-color: white;
    }

    li~.code {
        background-color: white;
    }

    .slim {
        width: 11%;
    }

    button {
        background-color: #424242;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        padding: 3px;
        transition: all 250ms;
        color: white;
    }

    button:hover {
        background-color: #5c5c5c;
        transition: all 250ms;
    }

    .digit {
        text-align: right;
    }

    tr:nth-child(2n) {
        background-color: #80808030;
    }

    .hide {
        float: right;
        position: relative;
        font-weight: 600;
        transition: opacity 150ms;
        opacity: 0%;
    }

    div:hover>.hide {
        opacity: 100%;
        transition: opacity 150ms;
    }

    @media (max-width: 1000px) {
        img {
            width: 70%;
            padding: 0 15%;
        }

        html {
            margin: 50px;
        }
    }

    .tab {
        margin-left: 40px;
    }

    @media (max-width: 600px) {
        img {
            width: 90%;
            padding: 0 5%;
        }

        html {
            margin: 30px;
        }
    }
</style>

<script>
    let buttons = [];

    function change(index) {
        const code = document.getElementById(`code${index}`);
        const codefield = document.getElementsByClassName("codefield");
        const button = document.getElementById(`button${index}`);

        if (buttons[index] == undefined || buttons[index] == false) {
            buttons[index] = true;
            button.innerHTML = "Hide code";

            code.style = "visibility: visible; height: auto; background-color: rgb(224, 224, 224); display: block;";
            codefield.style = "visibility: visible; height: auto; display: block;";
        }
        else {
            buttons[index] = false;
            button.innerHTML = "Show code";

            code.style = "visibility: hidden; height: 0; display: none";
            codefield.style = "visibility: hidden; height: 0; display: none";
        }
    }

</script>

</html>
